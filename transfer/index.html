<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transfer Borsasƒ± Pro v5.6 (Final Fix)</title>
    <script src="https://unpkg.com/twemoji@latest/dist/twemoji.min.js" crossorigin="anonymous"></script>
    
    <style>
        :root { 
            --bg-dark: #202225; --card-bg: #2f3136; --accent: #5865F2; --text: #dcddde; 
            --success: #3ba55c; --danger: #ed4245; --gold: #faa61a; 
            --gk-color: #d35400; --def-color: #2980b9; --mid-color: #27ae60; --fwd-color: #c0392b; 
        }
        body { background-color: var(--bg-dark); color: var(--text); font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; padding: 0; padding-bottom: 60px; }
        
        img.emoji { height: 1.2em; width: 1.2em; margin: 0 3px; vertical-align: -0.2em; }

        /* TOAST */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 3000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: #333; color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s ease-out; border-left: 5px solid gray; min-width: 250px; }
        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--danger); }
        .toast.info { border-left-color: var(--accent); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Gƒ∞Rƒ∞≈û */
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #202225; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; background-image: radial-gradient(circle, #2f3136 0%, #202225 100%); }
        .login-box { background: #2f3136; padding: 40px; border-radius: 12px; text-align: center; border: 1px solid var(--accent); width: 320px; box-shadow: 0 0 30px rgba(0,0,0,0.7); }
        .login-input { padding: 12px; width: 85%; margin-bottom: 15px; border-radius: 6px; border: 1px solid #40444b; background: #202225; color: white; text-align: center; font-size: 16px; outline: none; }
        .login-btn { background: var(--accent); color: white; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; font-size: 16px; transition: 0.3s; margin-bottom: 10px; }
        .guest-btn { background: transparent; border: 1px solid #72767d; color: #aaa; padding: 10px; width: 100%; border-radius: 6px; cursor: pointer; font-size: 14px; transition: 0.3s; }

        /* HEADER */
        .header { background-color: var(--card-bg); padding: 15px 20px; border-bottom: 2px solid #202225; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 90; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .header-left h1 { margin: 0; color: var(--accent); font-size: 22px; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 10px; }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .user-badge { display: flex; align-items: center; gap: 10px; background: #202225; padding: 5px 15px; border-radius: 20px; border: 1px solid #40444b; }
        .team-logo { width: 30px; height: 30px; object-fit: contain; display: block; }
        .budget-display { color: var(--success); font-weight: bold; font-family: monospace; font-size: 14px; }
        .admin-btn { background: var(--danger); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 12px; }
        .hub-btn { background: var(--accent); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 12px; }

        /* FILTER BAR */
        .filter-bar { background: #292b2f; padding: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; border-bottom: 1px solid #40444b; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-label { font-size: 11px; color: #aaa; font-weight: bold; text-transform: uppercase; }
        .filter-select, .filter-input { padding: 8px; background: #202225; border: 1px solid #40444b; color: white; border-radius: 5px; outline: none; min-width: 120px; }

        /* GRID */
        .container { max-width: 1400px; margin: 20px auto; padding: 0 20px; }
        .player-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 15px; }
        .card { background-color: var(--card-bg); border-radius: 8px; padding: 15px; border-left: 5px solid gray; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; gap: 8px; position: relative; overflow: hidden; }
        .card:hover { transform: translateY(-3px); background-color: #36393f; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .pos-kl { border-left-color: var(--gk-color) !important; }
        .pos-def { border-left-color: var(--def-color) !important; }
        .pos-mid { border-left-color: var(--mid-color) !important; }
        .pos-fwd { border-left-color: var(--fwd-color) !important; }
        .card-header { display: flex; justify-content: space-between; align-items: center; }
        .player-name { font-size: 16px; font-weight: bold; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .player-meta { font-size: 12px; color: #b9bbbe; display: flex; gap: 8px; align-items: center; }
        .badge { padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: bold; color: white; }
        .badge-pos { background: #40444b; }
        .badge-age { background: #4f545c; }
        .custom-flag { height: 24px !important; width: auto !important; margin-left: 4px; vertical-align: middle; position: relative; top: -2px; }

        /* MODAL */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background-color: #2f3136; width: 90%; max-width: 750px; max-height: 90vh; border-radius: 12px; overflow-y: auto; padding: 0; position: relative; border: 1px solid #40444b; box-shadow: 0 0 40px rgba(0,0,0,0.6); }
        .modal-close { position: absolute; top: 15px; right: 20px; font-size: 28px; cursor: pointer; color: #aaa; z-index: 10; }
        .profile-header { background: linear-gradient(to right, #202225, #2f3136); padding: 30px; display: flex; align-items: center; gap: 20px; border-bottom: 2px solid var(--accent); }
        .profile-avatar { width: 100px; height: 100px; border-radius: 12px; border: 2px solid var(--accent); overflow: hidden; background: #202225; display: flex; align-items: center; justify-content: center; font-size: 50px; box-shadow: 0 0 15px rgba(88, 101, 242, 0.3); }
        .profile-avatar img { width: 100%; height: 100%; object-fit: cover; }

        .profile-body { padding: 25px; }
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; }
        .stat-box h4 { color: var(--accent); margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 5px; }
        .stat-row { display: flex; justify-content: space-between; border-bottom: 1px solid #36393f; padding: 4px 0; font-size: 13px; }
        .val-high { color: var(--success); font-weight: bold; }
        .val-med { color: var(--gold); }
        .val-low { color: var(--danger); }
        .action-area { margin-top: 20px; text-align: center; border-top: 1px solid #444; padding-top: 20px; }
        .main-btn { background: var(--accent); color: white; padding: 12px 30px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .main-btn:disabled { background: #4f545c; cursor: not-allowed; opacity: 0.7; }

        /* TICKER */
        .news-ticker { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--accent); color: white; padding: 10px 0; white-space: nowrap; overflow: hidden; z-index: 99; border-top: 3px solid #202225; font-size: 14px; font-weight: 500; }
        .ticker-content { display: inline-block; padding-left: 100%; animation: ticker 40s linear infinite; }
        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }
        
        /* TRANSFER HUB STYLE */
        .hub-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px; }
        .hub-box { background: #222; padding: 15px; border-radius: 8px; border: 1px solid #444; height: 350px; overflow-y: auto; }
        .hub-title { color: var(--gold); border-bottom: 1px solid #555; padding-bottom: 5px; margin-bottom: 10px; font-size: 16px; }
        .transfer-row { display: flex; justify-content: space-between; font-size: 13px; border-bottom: 1px solid #333; padding: 8px 0; align-items: center; }
        .t-player { color: white; font-weight: bold; }
        .t-team { color: #aaa; font-size: 12px; }
        .t-price { color: var(--success); font-weight: bold; }
        .sign-btn { background: linear-gradient(45deg, #3ba55c, #2d7d46); width: 100%; padding: 15px; border: none; border-radius: 8px; color: white; font-size: 18px; font-weight: bold; cursor: pointer; animation: pulse 2s infinite; }
        
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--accent); border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .offer-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        .offer-table th { text-align: left; color: var(--gold); border-bottom: 1px solid #555; padding: 8px; }
        .offer-table td { padding: 8px; border-bottom: 1px solid #444; }
        .confirm-btn { background: var(--success); padding: 8px 15px; border: none; border-radius: 5px; color: white; cursor: pointer; font-weight: bold; margin-left: 5px; }
        .offer-input { padding: 8px; border-radius: 5px; border: 1px solid #555; background: #222; color: white; width: 100px; text-align: center; }
        
        #error-msg { text-align: center; width: 100%; color: #ed4245; margin-top: 50px; display: none; }
    </style>
</head>
<body>
    <div id="toast-container"></div>

    <div id="loginScreen" class="login-overlay">
        <div class="login-box">
            <h2 style="color:#5865F2; margin-bottom:10px;">MENAJER Gƒ∞Rƒ∞≈ûƒ∞</h2>
            <p style="color:#aaa; font-size:12px; margin-bottom:20px;">Takƒ±m ≈üifrenizi giriniz</p>
            <input type="password" id="passwordInput" class="login-input" placeholder="≈ûifre...">
            <button class="login-btn" onclick="loginSystem()">Gƒ∞Rƒ∞≈û YAP</button>
            <button class="guest-btn" onclick="loginAsGuest()">Misafir Olarak Gir</button>
            <p id="loginError" style="color:red; font-size:13px; margin-top:10px; display:none;">‚ùå Hatalƒ± ≈üifre!</p>
        </div>
    </div>

    <div class="header">
        <div class="header-left">
            <h1>‚öΩ TRANSFER BORSASI <span style="font-size:12px; color:#555; margin-left:10px;">PRO v5.6</span></h1>
        </div>
        <div class="header-right">
            <div class="user-badge" id="userBadge" style="display:none;">
                <img src="" id="headerLogo" class="team-logo" style="display:none;">
                <div style="display:flex; flex-direction:column; align-items:flex-start;">
                    <span id="userDisplay"></span>
                    <span id="userBudget" class="budget-display"></span>
                </div>
            </div>
            
            <div style="display:flex; gap:10px;">
                <button class="hub-btn" onclick="openTransferHub()">üåç Transfer Merkezi</button>
                <div id="adminPanel" style="display:none; gap:10px;">
                    <button class="admin-btn" onclick="openOffersModal()">üìã Teklifler</button>
                    <button class="admin-btn" style="background-color: #faa61a; color:black;" onclick="advanceGame()">‚è© HAFTA ƒ∞LERLET</button>
                    <button class="admin-btn" style="background:#ed4245;" onclick="clearData()">üóëÔ∏è Sƒ±fƒ±rla</button>
                </div>
            </div>
        </div>
    </div>

    <div class="filter-bar">
        <div class="filter-group">
            <label class="filter-label">ƒ∞sim Ara</label>
            <input type="text" id="filterName" class="filter-input" placeholder="Oyuncu adƒ±..." onkeyup="filterAll()">
        </div>
        <div class="filter-group">
            <label class="filter-label">Mevki</label>
            <select id="filterPos" class="filter-select" onchange="filterAll()">
                <option value="all">T√ºm√º</option>
                <option value="KL">Kaleci</option>
                <option value="STP">Stoper</option>
                <option value="Bek">Bekler</option>
                <option value="OS">Orta Saha</option>
                <option value="Kanat">Kanatlar</option>
                <option value="SNT">Forvet</option>
            </select>
        </div>
        <div class="filter-group">
            <label class="filter-label">Kƒ±ta</label>
            <select id="filterContinent" class="filter-select" onchange="filterAll()">
                <option value="all">T√ºm√º</option>
                <option value="Europe">Avrupa</option>
                <option value="South America">G√ºney Amerika</option>
                <option value="Africa">Afrika</option>
                <option value="Asia">Asya</option>
                <option value="North America">Kuzey Amerika</option>
            </select>
        </div>
        <div class="filter-group">
            <label class="filter-label">Ya≈ü</label>
            <select id="filterAge" class="filter-select" onchange="filterAll()">
                <option value="all">Farketmez</option>
                <option value="u21">21 Ya≈ü Altƒ± (Gen√ß)</option>
                <option value="21-29">21 - 29 Arasƒ±</option>
                <option value="30+">30+ (Tecr√ºbeli)</option>
            </select>
        </div>
        <div class="filter-group">
            <label class="filter-label">√úlke</label>
            <select id="filterCountry" class="filter-select" onchange="filterAll()">
                <option value="all">T√ºm√º</option>
                </select>
        </div>
    </div>

    <div id="error-msg">‚ö†Ô∏è Veri hatasƒ±! L√ºtfen en alttaki veri kutusunu kontrol et.</div>

    <div class="container">
        <div class="player-grid" id="grid">
            <p style="text-align:center; width:100%; color:#888;">Veriler y√ºkleniyor...</p>
        </div>
    </div>

    <div class="news-ticker">
        <div class="ticker-content" id="newsTicker">
            üî• TRANSFER D√ñNEMƒ∞ A√áILDI! TAKIMLAR KADROLARINI G√ú√áLENDƒ∞RMEK ƒ∞√áƒ∞N √áALI≈ûMALARA BA≈ûLADI...
        </div>
    </div>

    <div id="profileModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal(null)">&times;</span>
            <div class="profile-header">
                <div class="profile-avatar" id="modalFlag" data-emoji="üåç">üåç</div>
                <div>
                    <h2 id="modalName" style="color:white; margin:0 0 5px 0;">Oyuncu Adƒ±</h2>
                    <div style="color:#aaa; font-size:14px;" id="modalMeta">Bilgiler...</div>
                    <div id="modalTeamBadge" style="margin-top:5px; font-weight:bold; color:var(--gold);"></div>
                </div>
            </div>
            <div class="profile-body">
                <div id="unscoutedView" style="text-align:center; padding:20px 0;">
                    <p style="color:#aaa; font-size:16px; margin-bottom:20px;">üîí Bu oyuncu hakkƒ±nda detaylƒ± raporunuz yok.</p>
                    <button class="main-btn" onclick="scoutCurrentPlayer()" id="btnScout">
                        <span id="scoutBtnText">üïµÔ∏è G√∂zlemci G√∂nder</span>
                    </button>
                </div>
                <div id="scoutedView" style="display:none;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:20px; background:#222; padding:15px; border-radius:8px; border:1px solid #444;">
                        <div style="text-align:center; width:48%;">
                            <div style="font-size:12px; color:#aaa; margin-bottom:5px;">Piyasa Deƒüeri</div>
                            <div style="color:#3ba55c; font-weight:bold; font-size:18px;" id="modalValue">?</div>
                        </div>
                        <div style="text-align:center; width:48%; border-left:1px solid #444;">
                            <div style="font-size:12px; color:#aaa; margin-bottom:5px;">Maa≈ü Talebi</div>
                            <div style="color:#faa61a; font-weight:bold; font-size:18px;" id="modalWage">?</div>
                        </div>
                    </div>
                    <div style="background:#36393f; padding:15px; border-radius:8px; margin-bottom:20px; font-style:italic; color:#dcddde; border-left:4px solid var(--accent);" id="modalComment">...</div>
                    <div class="stat-grid">
                        <div class="stat-box"><h4>Teknik</h4><div id="techStats"></div></div>
                        <div class="stat-box"><h4>Zihinsel</h4><div id="mentalStats"></div></div>
                        <div class="stat-box"><h4>Fiziksel</h4><div id="physStats"></div></div>
                    </div>
                    <div class="action-area" id="offerArea"></div>
                    <div id="offerInputs" style="display:none; flex-direction:column; align-items:center; gap:10px; margin-top:10px;">
                        <input type="number" id="offerAmount" class="offer-input" placeholder="Tutar (‚Ç¨)...">
                        <div style="display:flex; gap:10px;">
                            <button class="confirm-btn" onclick="submitOffer()">Teklifi G√∂nder</button>
                            <button class="confirm-btn" style="background:#ed4245;" onclick="hideOfferInputs()">ƒ∞ptal</button>
                        </div>
                    </div>
                    <div id="counterOfferArea" style="display:none; background:#443300; padding:15px; border-radius:8px; margin-top:15px; border:1px solid #faa61a;">
                        <h4 style="color:#faa61a; margin:0 0 10px 0;">‚ö†Ô∏è Oyuncu Kar≈üƒ± Teklif Yaptƒ±!</h4>
                        <p id="counterText" style="font-size:13px; margin-bottom:10px;"></p>
                        <div style="display:flex; gap:10px; justify-content:center;">
                            <button class="confirm-btn" onclick="acceptCounterOffer()">Kabul Et</button>
                            <button class="confirm-btn" style="background:#ed4245;" onclick="rejectCounterOffer()">Reddet</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="offersModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content" style="padding:20px;">
            <span class="modal-close" onclick="closeOffersModal()">&times;</span>
            <h2 style="color:white; border-bottom:2px solid var(--gold); padding-bottom:10px;">üìã T√ºm Teklifler</h2>
            <div style="overflow-x:auto;">
                <table class="offer-table">
                    <thead><tr><th>Takƒ±m</th><th>Oyuncu</th><th>Teklif</th><th>Durum</th></tr></thead>
                    <tbody id="offersTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="transferHubModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content" style="max-width: 900px;">
            <span class="modal-close" onclick="document.getElementById('transferHubModal').style.display='none'">&times;</span>
            <h2 style="color:white; border-bottom:2px solid var(--accent); padding-bottom:10px;">üåç Transfer D√ºnyasƒ±</h2>
            <div class="hub-grid">
                <div class="hub-box">
                    <h3 class="hub-title">‚úÖ Son ƒ∞mzalar</h3>
                    <div id="completedTransfersList"><p style="color:#666; text-align:center; margin-top:20px;">Hen√ºz transfer yok.</p></div>
                </div>
                <div class="hub-box">
                    <h3 class="hub-title">üí∞ Masadaki Teklifler</h3>
                    <div id="topOffersList"><p style="color:#666; text-align:center; margin-top:20px;">Hen√ºz b√ºy√ºk bir teklif yok.</p></div>
                </div>
            </div>
        </div>
    </div>

    <textarea id="raw-data" style="display:none;">
    </textarea>
    <script>
        // --- 1. AYARLAR ---
        // Varsayƒ±lan Sil√ºet G√∂rseli (Hi√ßbir fotoƒüraf bulunamazsa bu g√∂sterilecek)
        const PLACEHOLDER_FACE_URL = "https://raw.githubusercontent.com/merenzer/merenzer.github.io/main/face/default_silhouette.png";

        // D√ºzeltilmi≈ü RAW Linkler (SarpEfeKus kullanƒ±cƒ±sƒ± i√ßin)
        const LOGO_BASE_URLS = [
            "https://github.com/merenzer/merenzer.github.io/tree/main/logolar", 
            "https://github.com/merenzer/merenzer.github.io/tree/main/logolar2"
        ];

        const FACE_BASE_URLS = [
            "https://github.com/merenzer/merenzer.github.io/tree/main/face",
            "https://github.com/merenzer/merenzer.github.io/tree/main/face2",
            "https://github.com/merenzer/merenzer.github.io/tree/main/face3",
            "https://github.com/merenzer/merenzer.github.io/tree/main/face4",
            "https://github.com/merenzer/merenzer.github.io/tree/main/face5",
            "https://github.com/merenzer/merenzer.github.io/tree/main/face6",
            "https://github.com/merenzer/merenzer.github.io/tree/main/face7",
            "https://github.com/merenzer/merenzer.github.io/tree/main/face8",
            "https://github.com/merenzer/merenzer.github.io/tree/main/face9"
        ];

        // 1. ƒ∞NSAN KULLANICILAR (B√úT√áE EKLENDƒ∞ - Mƒ∞LYON EURO)
        const teamCredentials = {
            "admin":   { name: "Y√ñNETƒ∞Cƒ∞", role: "admin", logo: "", rep: 5, budget: 999 },
            // TIER S
            "g√∂zg√∂z":  { name: "G√∂ztepe", role: "user", logo: "G√∂ztepe.png", rep: 5, budget: 500.0 },
            "ey√ºp":    { name: "Redbull Ey√ºpspor", role: "user", logo: "Ey√ºpspor.png", rep: 4, budget: 480.0 },
            // TIER A
            "cimbom":  { name: "Galatasaray", role: "user", logo: "Galatasaray.png", rep: 5, budget: 450.0 },
            "fener":   { name: "Fenerbah√ße", role: "user", logo: "Fenerbah√ße.png", rep: 5, budget: 410.0 },
            // TIER B
            "fƒ±rtƒ±na": { name: "Trabzonspor", role: "user", logo: "Trabzonspor.png", rep: 4, budget: 350.0 },
            // TIER C
            "samsun":  { name: "Samsunspor", role: "user", logo: "Samsunspor.png", rep: 3, budget: 270.0 },
            // TIER D
            "√ßorum":   { name: "Arca √áorum FK", role: "user", logo: "√áorum FK.png", rep: 2, budget: 180.0 },
            "alanya":  { name: "Alanyaspor", role: "user", logo: "Alanyaspor.png", rep: 2, budget: 190.0 }
        };

        // 2. BOT TAKIMLAR
        const botTeams = [
            // TIER B
            { name: "Be≈üikta≈ü JK", logo: "Be≈üikta≈ü.png", rep: 4, budget: 330.0 },
            // TIER C
            { name: "Bursaspor", logo: "Bursaspor.png", rep: 3, budget: 240.0 },
            // TIER D
            { name: "Sivasspor", logo: "Sivasspor.png", rep: 2, budget: 190.0 },
            { name: "Gen√ßlerbirliƒüi", logo: "Gen√ßlerbirliƒüi.png", rep: 2, budget: 200.0 },
            // TIER E
            { name: "Kocaelispor", logo: "Kocaelispor.png", rep: 2, budget: 170.0 },
            { name: "MKE Ankarag√ºc√º", logo: "Ankarag√ºc√º.png", rep: 2, budget: 165.0 },
            { name: "√áaykur Rizespor", logo: "Rizespor.png", rep: 1, budget: 160.0 },
            { name: "Kasƒ±mpa≈üa", logo: "Kasƒ±mpa≈üa.png", rep: 1, budget: 155.0 },
            { name: "ƒ∞stanbulspor", logo: "ƒ∞stanbulspor.png", rep: 1, budget: 145.0 },
            // TIER F
            { name: "Kayserispor", logo: "Kayserispor.png", rep: 1, budget: 110.0 }
        ];

        // ... DEƒûƒ∞≈ûKENLER ...
        let currentUser = null;
        let playerDB = {};
        let currentPlayerId = null;
        let offersDB = [];
        let transferHistory = [];
        let scoutedPlayers = [];
        let availableCountries = new Set();
        let counterOfferData = null; 

        // KITA VE EMOJƒ∞ HARƒ∞TALARI (Kƒ±saltƒ±ldƒ±)
        const continentMap={ "Europe":["T√ºrkiye","Turkey","Turkiye","Almanya","Fransa","ƒ∞talya","ƒ∞spanya","Portekiz","Hollanda","Bel√ßika","ƒ∞ngiltere","ƒ∞sko√ßya","Galler","ƒ∞rlanda","Kuzey ƒ∞rlanda","ƒ∞svi√ßre","Avusturya","Polonya","Macaristan","√áekya","Slovakya","Rusya","Ukrayna","Belarus","Romanya","Bulgaristan","Yunanistan","G√ºney Kƒ±brƒ±s","Kuzey Kƒ±brƒ±s","Sƒ±rbistan","Hƒ±rvatistan","Bosna","Bosna Hersek","Slovenya","Kuzey Makedonya","Karadaƒü","Kosova","Arnavutluk","Finlandiya","ƒ∞sve√ß","Norve√ß","Danimarka","ƒ∞zlanda","Faroe","Moldova","San Marino","Cebelitarƒ±k","Andorra","Lihten≈ütayn","L√ºksemburg","Monako","Malta"],"South America":["Brezilya","Arjantin","Uruguay","Kolombiya","≈ûili","Peru","Paraguay","Ekvador","Venezuela","Bolivya"],"Africa":["Nijerya","Kamerun","Gana","Fildi≈üi","Fildi≈üi Sahili","Senegal","Mƒ±sƒ±r","Fas","Cezayir","Tunus","Libya","Zambiya","Zimbabve","G√ºney Afrika","Tanzanya","Kenya","Kongo","DR Kongo","Gine","Mali"],"Asia":["√áin","G√ºney Kore","Kuzey Kore","Japonya","Avustralya","√ñzbekistan","Kazakistan","ƒ∞ran","Vietnam","Suriye","Endonezya","Umman","Afganistan","√úrd√ºn","Malezya","Tayland","BAE","Katar","Kƒ±rgƒ±zistan"],"North America":["ABD","Kanada","Meksika","Jamaika","Martinik","Guadeloupe","Trinidad","Panama","Kosta Rika","Honduras"]};
        const emojiMap={ "T√ºrkiye":"üáπüá∑","Turkey":"üáπüá∑","Turkiye":"üáπüá∑","Bolivya":"üáßüá¥","Brezilya":"üáßüá∑","Paraguay":"üáµüáæ","≈ûili":"üá®üá±","Peru":"üáµüá™","Arjantin":"üá¶üá∑","Uruguay":"üá∫üáæ","Venezuela":"üáªüá™","Ekvador":"üá™üá®","Kolombiya":"üá®üá¥","Meksika":"üá≤üáΩ","Kanada":"üá®üá¶","Jamaika":"üáØüá≤","Martinik":"üá≤üá∂","Guadeloupe":"üá¨üáµ","Trinidad":"üáπüáπ","ABD":"üá∫üá∏","Panama":"üáµüá¶","Kosta Rika":"üá®üá∑","Honduras":"üá≠üá≥","√áin":"üá®üá≥","G√ºney Kore":"üá∞üá∑","Kuzey Kore":"üá∞üáµ","Japonya":"üáØüáµ","Avustralya":"üá¶üá∫","√ñzbekistan":"üá∫üáø","Kazakistan":"üá∞üáø","ƒ∞ran":"üáÆüá∑","Vietnam":"üáªüá≥","Suriye":"üá∏üáæ","Endonezya":"üáÆüá©","Umman":"üá¥üá≤","Afganistan":"üá¶üá´","√úrd√ºn":"üáØüá¥","Malezya":"üá≤üáæ","Tayland":"üáπüá≠","BAE":"üá¶üá™","Katar":"üá∂üá¶","Kƒ±rgƒ±zistan":"üá∞üá¨","Nijerya":"üá≥üá¨","Kamerun":"üá®üá≤","Gana":"üá¨üá≠","Fildi≈üi":"üá®üáÆ","Senegal":"üá∏üá≥","Mƒ±sƒ±r":"üá™üá¨","Fas":"üá≤üá¶","Cezayir":"üá©üáø","Tunus":"üáπüá≥","Libya":"üá±üáæ","Zambiya":"üáøüá≤","Zimbabve":"üáøüáº","G√ºney Afrika":"üáøüá¶","Tanzanya":"üáπüáø","Kenya":"üá∞üá™","Kongo":"üá®üá¨","DR Kongo":"üá®üá©","Gine":"üá¨üá≥","Mali":"üá≤üá±","ƒ∞talya":"üáÆüáπ","ƒ∞spanya":"üá™üá∏","Portekiz":"üáµüáπ","Fransa":"üá´üá∑","Almanya":"üá©üá™","Hollanda":"üá≥üá±","Bel√ßika":"üáßüá™","ƒ∞ngiltere":"üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø","ƒ∞sko√ßya":"üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø","Galler":"üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø","Kuzey ƒ∞rlanda":"üáØüá™","ƒ∞rlanda":"üáÆüá™","ƒ∞svi√ßre":"üá®üá≠","Avusturya":"üá¶üáπ","Polonya":"üáµüá±","Macaristan":"üá≠üá∫","√áekya":"üá®üáø","Slovakya":"üá∏üá∞","Rusya":"üá∑üá∫","Ukrayna":"üá∫üá¶","Belarus":"üáßüáæ","Romanya":"üá∑üá¥","Bulgaristan":"üáßüá¨","Yunanistan":"üá¨üá∑","G√ºney Kƒ±brƒ±s":"üá®üáæ","Kuzey Kƒ±brƒ±s":"üáπüá∑","Sƒ±rbistan":"üá∑üá∏","Hƒ±rvatistan":"üá≠üá∑","Bosna":"üáßüá¶","Slovenya":"üá∏üáÆ","Kuzey Makedonya":"üá≤üá∞","Karadaƒü":"üá≤üá™","Kosova":"üáΩüá∞","Arnavutluk":"üá¶üá±","Finlandiya":"üá´üáÆ","ƒ∞sve√ß":"üá∏üá™","Norve√ß":"üá≥üá¥","Danimarka":"üá©üá∞","ƒ∞zlanda":"üáÆüá∏","Faroe":"üá´üá¥","Moldova":"üá≤üá©","San Marino":"üá∏üá≤","Cebelitarƒ±k":"üá¨üáÆ","Andorra":"üá¶üá©","Lihten≈ütayn":"üá±üáÆ","L√ºksemburg":"üá±üá∫","Monako":"üá≤üá®","Malta":"üá≤üáπ"};

        // --- 3. Y√úKLEME FONKSƒ∞YONLARI ---
        function loadLogo(imgElement, logoName, urlIndex = 0) {
            if (urlIndex >= LOGO_BASE_URLS.length) {
                imgElement.style.display = 'none';
                return;
            }
            let url = LOGO_BASE_URLS[urlIndex] + encodeURIComponent(logoName);
            imgElement.src = url;
            imgElement.onerror = function() { loadLogo(imgElement, logoName, urlIndex + 1); };
        }

        // --- Y√úZ PAKETƒ∞ ƒ∞Sƒ∞M BELƒ∞RLEYƒ∞Cƒ∞ ---
        function getPlayerFileName(id) {
            let numId = parseInt(id);
            if (numId >= 1 && numId <= 201) return `sam${numId}.png`;
            if (numId >= 202 && numId <= 225) return `nam${numId}.png`;
            if (numId >= 226 && numId <= 300) return `asian${numId}.png`;
            if (numId >= 301 && numId <= 514) return `afr${numId}.png`;
            if (numId >= 515 && numId <= 890) return `euro${numId}.png`;
            return `${numId}.png`; // Fallback
        }

        // --- AKILLI Y√úZ Y√úKLEYƒ∞Cƒ∞ (SMART FALLBACK - TARGETED) ---
        function loadFace(containerElement, playerId, urlIndex = 0, tryBare = false) {
            // Eƒüer img etiketi yoksa olu≈ütur
            let img = containerElement.querySelector("img");
            if (!img) {
                containerElement.innerHTML = ""; 
                img = document.createElement("img");
                img.style.width = "100%";
                img.style.height = "100%";
                img.style.objectFit = "cover";
                containerElement.appendChild(img);
            }

            // HEDEF KLAS√ñR√ú BELƒ∞RLE (NOKTA ATI≈ûI)
            let numId = parseInt(playerId);
            let targetFolderIndex = -1;

            if (numId >= 1 && numId <= 201) targetFolderIndex = [0,1,2]; // face, face2, face3
            else if (numId >= 202 && numId <= 300) targetFolderIndex = [2]; // face3
            else if (numId >= 301 && numId <= 514) targetFolderIndex = [3,4,5]; // face4,5,6
            else if (numId >= 515) targetFolderIndex = [6,7,8]; // face7,8,9

            // Eƒüer urlIndex parametresi g√∂nderilmemi≈üse, doƒüru ba≈ülangƒ±√ß noktasƒ±nƒ± se√ß
            if (urlIndex === 0 && Array.isArray(targetFolderIndex)) {
                urlIndex = targetFolderIndex[0];
            }

            // Eƒüer hedef klas√∂rlerin dƒ±≈üƒ±na √ßƒ±ktƒ±ysak -> EMOJƒ∞
            if (Array.isArray(targetFolderIndex) && !targetFolderIndex.includes(urlIndex)) {
                 if (!tryBare) {
                    loadFace(containerElement, playerId, targetFolderIndex[0], true);
                    return;
                }
                
                let flagEmoji = containerElement.getAttribute("data-emoji") || "üåç";
                containerElement.innerHTML = `<span style="font-size:50px;">${flagEmoji}</span>`;
                return;
            }

            // Dosya Adƒ±
            let fileName;
            if (tryBare) {
                 fileName = playerId + ".png"; 
            } else {
                 fileName = getPlayerFileName(playerId); 
            }

            let url = FACE_BASE_URLS[urlIndex] + fileName; 
            img.src = url;
            
            // Hata olursa bir sonraki klas√∂re ge√ß
            img.onerror = function() { 
                loadFace(containerElement, playerId, urlIndex + 1, tryBare); 
            };
        }

        // --- LOCAL STORAGE ---
        function saveData() {
            localStorage.setItem('tbor_offers', JSON.stringify(offersDB));
            localStorage.setItem('tbor_transfers', JSON.stringify(transferHistory));
            localStorage.setItem('tbor_scouted', JSON.stringify(scoutedPlayers));
            
            let soldPlayers = {};
            for(let id in playerDB) {
                if(playerDB[id].team !== "Serbest" && playerDB[id].team !== "Bilinmiyor") {
                    soldPlayers[id] = playerDB[id].team;
                }
            }
            localStorage.setItem('tbor_sold_players', JSON.stringify(soldPlayers));

            let budgets = {};
            for(let key in teamCredentials) {
                if(teamCredentials[key].role === "user") {
                    budgets[key] = teamCredentials[key].budget;
                }
            }
            localStorage.setItem('tbor_budgets', JSON.stringify(budgets));
        }

        function loadData() {
            if(localStorage.getItem('tbor_offers')) offersDB = JSON.parse(localStorage.getItem('tbor_offers'));
            if(localStorage.getItem('tbor_transfers')) transferHistory = JSON.parse(localStorage.getItem('tbor_transfers'));
            if(localStorage.getItem('tbor_scouted')) scoutedPlayers = JSON.parse(localStorage.getItem('tbor_scouted'));
            
            if(localStorage.getItem('tbor_sold_players')) {
                let soldMap = JSON.parse(localStorage.getItem('tbor_sold_players'));
                for(let id in soldMap) {
                    if(playerDB[id]) {
                        playerDB[id].team = soldMap[id];
                        playerDB[id].status = "S√∂zle≈ümeli";
                    }
                }
            }

            if(localStorage.getItem('tbor_budgets')) {
                let savedBudgets = JSON.parse(localStorage.getItem('tbor_budgets'));
                for(let key in savedBudgets) {
                    if(teamCredentials[key]) {
                        teamCredentials[key].budget = savedBudgets[key];
                    }
                }
            }
        }
        
        function clearData() {
            if(confirm("T√úM VERƒ∞LER Sƒ∞Lƒ∞NECEK! Emin misin?")) {
                localStorage.clear();
                location.reload();
            }
        }

        // --- YARDIMCI ---
        function showToast(msg, type="info") {
            const container = document.getElementById("toast-container");
            const toast = document.createElement("div");
            toast.className = `toast ${type}`;
            toast.innerHTML = msg;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = "slideOut 0.3s ease-in forwards";
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function generatePhysique(pos) {
            let h = pos.includes("KL") || pos.includes("STP") ? Math.floor(Math.random()*16+182) : Math.floor(Math.random()*17+168);
            let w = Math.floor(Math.random()*20+65);
            return { h: (h/100).toFixed(2)+" m", w: w+" kg" };
        }

        function getContinent(countryName) {
            for (const [continent, countries] of Object.entries(continentMap)) {
                if (countries.includes(countryName)) return continent;
            }
            return "Other";
        }

        function getPosClass(pos) {
            if(pos.includes("KL")) return "pos-kl";
            if(pos.includes("STP") || pos.includes("Bek")) return "pos-def";
            if(pos.includes("OS") || pos.includes("OOS") || pos.includes("DOS")) return "pos-mid";
            if(pos.includes("SNT") || pos.includes("Kanat")) return "pos-fwd";
            return "";
        }

        // --- Gƒ∞Rƒ∞≈û ---
        function loginSystem() {
            const input = document.getElementById("passwordInput").value.toLowerCase();
            if (teamCredentials[input]) {
                currentUser = teamCredentials[input];
                currentUser.key = input; 
                document.getElementById("loginScreen").style.display = "none";
                updateUserDisplay();
                showToast(`Ho≈ü geldin ${currentUser.name}! B√ºt√ße: ‚Ç¨${currentUser.budget}M`, "success");
            } else { document.getElementById("loginError").style.display = "block"; }
        }

        function loginAsGuest() {
            currentUser = { name: "Misafir", role: "guest", logo: "", rep: 0, budget: 0 };
            document.getElementById("loginScreen").style.display = "none";
            updateUserDisplay();
        }

        function updateUserDisplay() {
            document.getElementById("userDisplay").innerText = currentUser.name;
            if(currentUser.role === "user") {
                document.getElementById("userBudget").innerText = `B√ºt√ße: ‚Ç¨${currentUser.budget.toFixed(1)}M`;
            } else {
                document.getElementById("userBudget").innerText = "";
            }

            document.getElementById("userBadge").style.display = "flex";
            if(currentUser.logo) {
                const imgEl = document.getElementById("headerLogo");
                imgEl.style.display = "block";
                loadLogo(imgEl, currentUser.logo);
            }
            if(currentUser.role === "admin") {
                document.getElementById("adminPanel").style.display = "flex";
                document.getElementById("userDisplay").style.color = "#ed4245";
            }
        }

        // --- PARSE ---
        function parseData() {
            loadData(); 
            const rawDataInput = document.getElementById("raw-data").value;
            if(!rawDataInput || rawDataInput.length < 20) return;
            const rawList = rawDataInput.split("ID: ");
            let gridHTML = "";
            
            rawList.forEach(item => {
                if(item.trim() === "") return;
                try {
                    let lines = item.split("\n");
                    let id = lines[0].split("|")[0].trim();
                    let name = lines[0].split("|")[1] ? lines[0].split("|")[1].trim() : "ƒ∞simsiz";
                    let fullText = item.replace(/\n/g, " ");

                    // ƒ∞SMƒ∞ TEMƒ∞ZLE (Mevki, √úlke vb. kelimeleri at)
                    if (name.includes("Mevki:")) name = name.split("Mevki:")[0];
                    if (name.includes("√úlke:")) name = name.split("√úlke:")[0];
                    name = name.trim();

                    let statsIndex = item.search(/(Teknik|Kalecilik|Zihinsel|Fiziksel)/);
                    let infoPart = statsIndex > -1 ? item.substring(0, statsIndex) : item;
                    let yorum = (infoPart.match(/Yorum:([\s\S]*?)$/) || [])[1] || "Rapor yok.";

                    let mevki = (item.match(/Mevki: (.*?) \|/) || [])[1] || "Bilinmiyor";
                    let yas = (item.match(/Ya≈ü: (\d+)/) || [])[1] || 0;
                    let ca = (item.match(/CA: (\d+)/) || [])[1] || 100;
                    let deger = (item.match(/Deƒüeri: (.*?) \|/) || [])[1] || "Bilinmiyor";
                    let maas = (item.match(/Maa≈ü: (.*?) (Yorum|GEN√á|$)/) || [])[1] || "Bilinmiyor";
                    
                    let displayFlag = "üåç";
                    let detectedCountry = "Bilinmiyor";
                    let ulkeRaw = (item.match(/√úlke: (.*?) (?:Mevki)/) || [])[1] || "";
                    if(ulkeRaw.length < 2) { detectedCountry="T√ºrkiye"; displayFlag="üáπüá∑"; }
                    else {
                        for(const [k,v] of Object.entries(emojiMap)) { 
                            if(ulkeRaw.includes(k)) { displayFlag=v; detectedCountry=k; break; } 
                        }
                    }
                    availableCountries.add(detectedCountry);

                    let attributes = {};
                    let attrRegex = /([a-zA-Z√ß√áƒüƒûƒ±ƒ∞√∂√ñ≈ü≈û√º√ú]+)(\d{2})/g;
                    let match;
                    while ((match = attrRegex.exec(fullText)) !== null) {
                        if(!["Teknik","Zihinsel","Fiziksel","Kalecilik"].includes(match[1])) attributes[match[1]] = parseInt(match[2]);
                    }

                    let physique = generatePhysique(mevki);

                    // DB'de yoksa ekle
                    if(!playerDB[id]) {
                        playerDB[id] = {
                            id, name, mevki, yas, ca: parseInt(ca), flag: displayFlag, country: detectedCountry,
                            continent: getContinent(detectedCountry),
                            height: physique.h, weight: physique.w,
                            status: item.includes("SERBEST") ? "Serbest" : "S√∂zle≈ümeli",
                            team: item.includes("SERBEST") ? "Serbest" : "Bilinmiyor",
                            value: deger, wage: maas, comment: yorum.trim(), attributes
                        };
                        if(playerDB[id].status === "Serbest") playerDB[id].isScouted = true;
                    } else {
                        playerDB[id].name = name; 
                    }

                    let posClass = getPosClass(mevki);
                    let freeBadge = playerDB[id].status === "Serbest" ? `<span class="badge" style="background:#ed4245;">BEDELSƒ∞Z</span>` : "";

                    gridHTML += `
                        <div class="card ${posClass}" data-id="${id}" onclick="openProfile('${id}')">
                            <div class="card-header">
                                <span class="flag-icon">${displayFlag}</span>
                                <span style="color:#72767d; font-size:11px;">#${id}</span>
                            </div>
                            <div class="player-name">${name}</div>
                            <div class="player-meta">
                                <span class="badge badge-pos">${mevki.split(' ')[0]}</span>
                                <span class="badge badge-age">${yas}</span>
                                ${freeBadge}
                            </div>
                        </div>
                    `;
                } catch(e) { console.warn("Hata:", e); }
            });

            document.getElementById("grid").innerHTML = gridHTML;
            populateCountryFilter();
            if(typeof twemoji !== 'undefined') twemoji.parse(document.body);
            loadData();
        }

        // --- PROFƒ∞L ---
        function openProfile(id) {
            currentPlayerId = id;
            const p = playerDB[id];
            
            // Emoji'yi sakla (Y√ºz y√ºklenemezse geri d√∂neceƒüiz)
            const modalFlag = document.getElementById("modalFlag");
            modalFlag.innerHTML = p.flag; 
            modalFlag.setAttribute("data-emoji", p.flag); 

            // Y√úZ Y√úKLEME BA≈ûLAT
            loadFace(modalFlag, p.id);

            document.getElementById("modalName").innerText = p.name;
            document.getElementById("modalMeta").innerText = `${p.mevki} ‚Ä¢ ${p.yas} Ya≈ü ‚Ä¢ ${p.height} ‚Ä¢ ${p.weight} ‚Ä¢ ${p.status}`;
            document.getElementById("modalTeamBadge").innerHTML = p.team !== "Serbest" && p.team !== "Bilinmiyor" ? `<span style="color:var(--gold); font-weight:bold;">${p.team}</span>` : "";

            if (p.team === currentUser.name) {
                document.getElementById("scoutedView").style.display = "block";
                document.getElementById("unscoutedView").style.display = "none";
                document.getElementById("offerArea").innerHTML = `<div style="background:#2d7d46; padding:10px; border-radius:5px; color:white; font-weight:bold;">‚úÖ Bu oyuncu kadronuzda!</div>`;
                showAttributes(p);
                document.getElementById("profileModal").style.display = "flex";
                return;
            }

            if (p.isScouted) { showScoutedData(p); } 
            else {
                document.getElementById("unscoutedView").style.display = "block";
                document.getElementById("scoutedView").style.display = "none";
                const btn = document.getElementById("btnScout");
                if (currentUser.role === "guest") { btn.disabled = true; btn.innerHTML = "üö´ Misafir"; } 
                else { btn.disabled = false; btn.innerHTML = `<span id="scoutBtnText">üïµÔ∏è G√∂zlemci G√∂nder</span>`; }
            }
            document.getElementById("profileModal").style.display = "flex";
        }

        function scoutCurrentPlayer() {
            if(currentUser.role === "guest") return;
            document.getElementById("btnScout").innerHTML = `<span class="loader"></span>`;
            setTimeout(() => {
                playerDB[currentPlayerId].isScouted = true;
                scoutedPlayers.push(currentPlayerId);
                saveData();
                showScoutedData(playerDB[currentPlayerId]);
                showToast("Rapor hazƒ±rlandƒ±.", "success");
            }, 800);
        }

        function showScoutedData(p) {
            document.getElementById("unscoutedView").style.display = "none";
            document.getElementById("scoutedView").style.display = "block";
            document.getElementById("modalValue").innerText = p.status==="Serbest" ? "Bedelsiz" : p.value;
            document.getElementById("modalValue").style.color = p.status==="Serbest" ? "#ed4245" : "#3ba55c";
            document.getElementById("modalWage").innerText = p.wage;
            document.getElementById("modalComment").innerText = `"${p.comment}"`;
            
            showAttributes(p);
            checkOfferStatus(p);
            document.getElementById("counterOfferArea").style.display = "none"; 
        }

        function showAttributes(p) {
            let t="", m="", f="";
            const mKeys = ["Kararlƒ±lƒ±k","Liderlik","Takƒ±mOyunu","√áalƒ±≈ükanlƒ±k","Cesaret","Agresiflik","Soƒüukkanlƒ±lƒ±k","Konsantrasyon","PozisyonAlma","Sezgi","KararAlma","Vizyon"];
            const fKeys = ["Hƒ±z","Hƒ±zlanma","G√º√ß","Dayanƒ±klƒ±lƒ±k","Denge","√áeviklik","Zƒ±plama","V√ºcutZindeliƒüi"];
            for(const [k,v] of Object.entries(p.attributes)) {
                let cls = v>80?"val-high":v>55?"val-med":"val-low";
                let row = `<div class="stat-row"><span>${k}</span><span class="${cls}">${v}</span></div>`;
                if(fKeys.includes(k)) f+=row; else if(mKeys.includes(k)) m+=row; else t+=row;
            }
            document.getElementById("techStats").innerHTML=t;
            document.getElementById("mentalStats").innerHTML=m;
            document.getElementById("physStats").innerHTML=f;
        }

        // --- ƒ∞Tƒ∞BAR, B√úT√áE VE M√úZAKERE ---
        function submitOffer() {
            const amountVal = parseFloat(document.getElementById("offerAmount").value);
            if(!amountVal || amountVal <= 0) return showToast("Ge√ßerli bir miktar girin!", "error");

            // B√úT√áE KONTROL√ú
            if(amountVal > currentUser.budget) {
                return showToast(`‚ùå Yetersiz B√ºt√ße! (Mevcut: ‚Ç¨${currentUser.budget.toFixed(1)}M)`, "error");
            }

            const p = playerDB[currentPlayerId];
            let teamRep = currentUser.rep;

            // 1. D√ú≈û√úK ƒ∞Tƒ∞BAR CEZASI
            if(teamRep <= 1) {
                if(p.ca > 110) {
                    if(Math.random() < 0.7) { 
                         showToast(`Oyuncu temsilcisi: "Kul√ºb√ºn√ºz√ºn durumu nedeniyle oyuncum g√∂r√º≈ümek istemiyor."`, "error");
                         return;
                    }
                }
                let baseVal = p.ca * 100000;
                let minOffer = (baseVal * 3) / 1000000; 
                if(amountVal < minOffer) {
                    let counterAmount = minOffer.toFixed(1);
                    triggerCounterOffer(`Riskli bir kul√ºbe gelmem i√ßin en az ${counterAmount}M ‚Ç¨ gerekir.`, counterAmount);
                    return;
                }
            }

            // 2. YILDIZ OYUNCU KAPRƒ∞Sƒ∞
            if(p.ca > 135 && teamRep < 4) {
                 if(Math.random() < 0.4) {
                     let counterAmount = (amountVal * 1.5).toFixed(1);
                     triggerCounterOffer(`Daha b√ºy√ºk hedeflerim var ama ${counterAmount}M ‚Ç¨ verirseniz d√º≈ü√ºnebilirim.`, counterAmount);
                     return;
                 }
            }

            sendOfferProcess(amountVal);
        }

        function triggerCounterOffer(msg, amount) {
            document.getElementById("offerInputs").style.display = "none";
            document.getElementById("counterOfferArea").style.display = "block";
            document.getElementById("counterText").innerText = `"${msg}"`;
            document.getElementById("counterVal").innerText = `‚Ç¨${amount}M`;
            counterOfferData = amount;
        }

        function acceptCounterOffer() {
            let amount = parseFloat(counterOfferData);
            if(amount > currentUser.budget) {
                 return showToast(`‚ùå Kar≈üƒ± teklifi kabul edecek b√ºt√ßeniz yok!`, "error");
            }
            sendOfferProcess(amount);
            document.getElementById("counterOfferArea").style.display = "none";
        }

        function rejectCounterOffer() {
            document.getElementById("counterOfferArea").style.display = "none";
            document.getElementById("btnMakeOffer").style.display = "inline-flex";
            showToast("G√∂r√º≈ümeler sonlandƒ±rƒ±ldƒ±.", "error");
        }

        function sendOfferProcess(amountVal) {
            const p = playerDB[currentPlayerId];
            const amountStr = `‚Ç¨${amountVal}M`;
            offersDB.push({
                id: Date.now().toString(), team: currentUser.name, teamLogo: currentUser.logo,
                playerName: p.name, playerId: p.id, offerVal: amountVal,
                offer: amountStr, status: "Deƒüerlendiriliyor", timestamp: Date.now()
            });
            saveData(); 
            showToast("Teklifiniz kul√ºbe iletildi!", "success");
            updateTicker(`üì¢ ${currentUser.name}, ${p.name} i√ßin ${amountStr} teklif yaptƒ±!`);
            checkOfferStatus(p);
        }

        function checkOfferStatus(p) {
            const offerArea = document.getElementById("offerArea");
            const myOffer = offersDB.find(o => o.playerId === p.id && o.team === currentUser.name && o.status !== "Reddedildi" && o.status !== "ƒ∞ptal Edildi");
            
            document.getElementById("offerInputs").style.display = "none";
            
            if (myOffer) {
                if (myOffer.status === "Kabul Edildi") {
                    offerArea.innerHTML = `
                        <div style="text-align:center;">
                            <h3 style="color:#3ba55c;">üéâ TEKLƒ∞Fƒ∞Nƒ∞Z KABUL EDƒ∞LDƒ∞!</h3>
                            <button class="sign-btn" onclick="finalizeTransfer('${myOffer.id}')">‚úçÔ∏è S√ñZLE≈ûME ƒ∞MZALA (${myOffer.offer})</button>
                        </div>`;
                } else if(myOffer.status === "ƒ∞mzalandƒ±") {
                    offerArea.innerHTML = `<div style="background:#2d7d46; padding:10px; border-radius:5px; color:white; font-weight:bold;">‚úÖ Transfer Tamamlandƒ±</div>`;
                } else {
                    offerArea.innerHTML = `<div style="background:#faa61a; color:#222; padding:10px; border-radius:5px; font-weight:bold; text-align:center;">‚è≥ Teklif Deƒüerlendiriliyor... (${myOffer.offer})</div>`;
                }
            } else {
                if(currentUser.role === "guest") offerArea.innerHTML = "";
                else {
                    offerArea.innerHTML = `<button class="main-btn" style="background:#2d7d46;" onclick="showOfferInputs()" id="btnMakeOffer">üí∞ Teklif Yap</button>`;
                }
            }
        }

        function showOfferInputs() { document.getElementById("btnMakeOffer").style.display="none"; document.getElementById("offerInputs").style.display="flex"; }
        function hideOfferInputs() { document.getElementById("offerInputs").style.display="none"; document.getElementById("btnMakeOffer").style.display="inline-flex"; }

        function advanceGame() {
            if (currentUser.role !== "admin") return;
            let botOfferCount = 0;
            const keys = Object.keys(playerDB);
            for(let i=0; i<5; i++) {
                let rP = playerDB[keys[Math.floor(Math.random()*keys.length)]];
                let rT = botTeams[Math.floor(Math.random()*botTeams.length)];
                if(rP.team !== "Serbest" && rP.team !== "Bilinmiyor" && !rP.team.includes("Spor")) continue; 
                
                let baseVal = rP.ca * 100000;
                let multiplier = 0.8 + (rT.rep * 0.1); 
                let offerVal = (baseVal * multiplier).toFixed(1) / 1000000; 
                
                offersDB.push({
                    id: Date.now() + i, team: rT.name, teamLogo: rT.logo,
                    playerName: rP.name, playerId: rP.id, offerVal: parseFloat(offerVal),
                    offer: `‚Ç¨${offerVal.toFixed(1)}M`, status: "Deƒüerlendiriliyor", timestamp: Date.now()
                });
                botOfferCount++;
            }
            
            let processedPlayers = new Set();
            offersDB.forEach(offer => {
                if(offer.status === "Deƒüerlendiriliyor" && !processedPlayers.has(offer.playerId)) {
                    let allOffers = offersDB.filter(o => o.playerId === offer.playerId && o.status === "Deƒüerlendiriliyor");
                    if(allOffers.length > 0) {
                        allOffers.sort((a,b) => b.offerVal - a.offerVal);
                        let winner = allOffers[0];
                        winner.status = "Kabul Edildi";
                        for(let i=1; i<allOffers.length; i++) allOffers[i].status = "Reddedildi";
                        let isBotWinner = botTeams.some(bt => bt.name === winner.team);
                        if(isBotWinner) completeTransfer(winner);
                        else updateTicker(`‚úÖ ${winner.team}, ${winner.playerName} teklifi kabul edildi!`);
                    }
                    processedPlayers.add(offer.playerId);
                }
            });
            saveData();
            showToast(`Hafta ilerletildi. ${botOfferCount} bot teklifi.`, "success");
            updateHub();
        }

        function finalizeTransfer(offerId) {
            let offer = offersDB.find(o => o.id === offerId);
            if(offer) { 
                if(currentUser.budget >= offer.offerVal) {
                    currentUser.budget -= offer.offerVal;
                    teamCredentials[currentUser.key].budget = currentUser.budget; 
                    saveData();
                    updateUserDisplay();
                    
                    completeTransfer(offer); 
                    checkOfferStatus(playerDB[offer.playerId]);
                    showToast(`Transfer Tamam! Kalan B√ºt√ße: ‚Ç¨${currentUser.budget.toFixed(1)}M`, "success");
                } else {
                    showToast("Bu transferi tamamlamak i√ßin paranƒ±z yetmiyor!", "error");
                }
            }
        }

        function completeTransfer(offer) {
            transferHistory.push(offer);
            let p = playerDB[offer.playerId];
            p.team = offer.team; p.status = "S√∂zle≈ümeli"; p.value = offer.offer;
            offer.status = "ƒ∞mzalandƒ±";
            saveData();
            updateTicker(`üö® RESMƒ∞: ${offer.playerName} >> ${offer.team} Transferi Bitti!`);
            updateHub();
        }

        function openTransferHub() { updateHub(); document.getElementById("transferHubModal").style.display = "flex"; }
        function updateHub() {
            const transList = document.getElementById("completedTransfersList");
            if(transferHistory.length === 0) { transList.innerHTML = "<p style='color:#666; text-align:center;'>Hen√ºz ger√ßekle≈üen transfer yok.</p>"; } 
            else {
                let html = "";
                [...transferHistory].reverse().forEach(t => {
                    let logoHTML = t.teamLogo ? `<img src="${GITHUB_REPO_URL + encodeURI(t.teamLogo)}" style="width:20px; height:20px; vertical-align:middle; margin-right:5px;">` : "";
                    html += `<div class="transfer-row"><span class="t-player">${t.playerName}</span><span class="t-team">‚û°Ô∏è ${logoHTML}${t.team}</span><span class="t-price">${t.offer}</span></div>`;
                });
                transList.innerHTML = html;
                [...transferHistory].reverse().forEach(t => { if(t.teamLogo) loadLogo(document.getElementById(`hub_logo_${t.id}`), t.teamLogo); });
            }
            const topList = document.getElementById("topOffersList");
            let activeOffers = offersDB.filter(o => o.status === "Deƒüerlendiriliyor" || o.status === "Kabul Edildi");
            if(activeOffers.length === 0) { topList.innerHTML = "<p style='color:#666; text-align:center;'>Masada b√ºy√ºk teklif yok.</p>"; } 
            else {
                activeOffers.sort((a,b) => b.offerVal - a.offerVal);
                let html = "";
                activeOffers.slice(0, 10).forEach(o => {
                    let logoHTML = o.teamLogo ? `<img src="${GITHUB_REPO_URL + encodeURI(o.teamLogo)}" style="width:20px; height:20px; vertical-align:middle; margin-right:5px;">` : "";
                    html += `<div class="transfer-row"><span class="t-player">${o.playerName}</span><span class="t-team">${logoHTML}${o.team}</span><span class="t-price">${o.offer}</span></div>`;
                });
                topList.innerHTML = html;
                activeOffers.slice(0, 10).forEach(o => { if(o.teamLogo) loadLogo(document.getElementById(`top_logo_${o.id}`), o.teamLogo); });
            }
        }

        function contactAgent(btnElement) {
            const p = playerDB[currentPlayerId];
            btnElement.innerHTML = `<span class="loader" style="width:10px; height:10px;"></span>`;
            btnElement.disabled = true;

            setTimeout(() => {
                let baseVal = p.ca * 150000; 
                if(p.ca > 130) baseVal = p.ca * 300000;
                if(p.status === "Serbest") baseVal = baseVal * 0.1;

                let randomVal = Math.floor(baseVal + (Math.random() * 500000));
                let randomWage = Math.floor(randomVal / 10);

                let valStr = randomVal > 1000000 ? `‚Ç¨${(randomVal/1000000).toFixed(1)}M` : `‚Ç¨${(randomVal/1000).toFixed(0)}K`;
                let wageStr = randomWage > 1000000 ? `‚Ç¨${(randomWage/1000000).toFixed(1)}M` : `‚Ç¨${(randomWage/1000).toFixed(0)}K`;

                if(p.status === "Serbest") {
                    document.getElementById("modalValue").innerHTML = `<span style="color:#ed4245">Bedelsiz</span>`;
                    document.getElementById("modalWage").innerHTML = `<span style="color:#faa61a">${wageStr} (ƒ∞mza: ${valStr})</span>`;
                } else {
                    document.getElementById("modalValue").innerText = valStr;
                    document.getElementById("modalWage").innerText = wageStr;
                }
                btnElement.style.display = "none";
            }, 1000);
        }

        function openOffersModal() {
            const tbody = document.getElementById("offersTableBody");
            tbody.innerHTML = "";
            if(offersDB.length === 0) { tbody.innerHTML = "<tr><td colspan='4' style='color:#888; text-align:center;'>Hen√ºz teklif yok.</td></tr>"; } 
            else {
                [...offersDB].reverse().forEach(o => {
                    let logoHTML = o.teamLogo ? `<img src="${GITHUB_REPO_URL + encodeURI(o.teamLogo)}" style="width:20px; height:20px; vertical-align:middle; margin-right:5px;">` : "";
                    tbody.innerHTML += `<tr><td style="color:${o.team === 'Y√ñNETƒ∞Cƒ∞' ? 'var(--danger)' : 'var(--gold)'}">${logoHTML}${o.team}</td><td>${o.playerName}</td><td style="font-weight:bold; color:var(--success)">${o.offer}</td><td>${o.status}</td></tr>`;
                });
                [...offersDB].reverse().forEach(o => { if(o.teamLogo) loadLogo(document.getElementById(`all_logo_${o.id}`), o.teamLogo); });
            }
            document.getElementById("offersModal").style.display = "flex";
        }
        function closeOffersModal() { document.getElementById("offersModal").style.display = "none"; }
        function closeModal(e) { if (e === null || e.target.classList.contains("modal-overlay")) { document.querySelectorAll(".modal-overlay").forEach(m => m.style.display="none"); } }
        function populateCountryFilter() {
            const select = document.getElementById("filterCountry");
            let sortedCountries = Array.from(availableCountries).sort();
            sortedCountries.forEach(c => { let opt = document.createElement("option"); opt.value = c; opt.innerText = c; select.appendChild(opt); });
        }
        function filterAll() {
            const nameInput = document.getElementById("filterName").value.toUpperCase();
            const posInput = document.getElementById("filterPos").value;
            const contInput = document.getElementById("filterContinent").value;
            const ageInput = document.getElementById("filterAge").value;
            const countryInput = document.getElementById("filterCountry").value;
            const cards = document.getElementsByClassName("card");

            for (let i = 0; i < cards.length; i++) {
                let id = cards[i].getAttribute("data-id");
                let p = playerDB[id];
                let show = true;
                if (p.name.toUpperCase().indexOf(nameInput) === -1) show = false;
                if (posInput !== "all" && !p.mevki.includes(posInput)) { if (posInput === "Bek" && (p.mevki.includes("SƒûB") || p.mevki.includes("SLB"))) {} else if (posInput === "Kanat" && (p.mevki.includes("SƒûK") || p.mevki.includes("SLK"))) {} else show = false; }
                if (contInput !== "all" && p.continent !== contInput) show = false;
                if (countryInput !== "all" && p.country !== countryInput) show = false;
                if (ageInput !== "all") { if (ageInput === "u21" && p.yas >= 21) show = false; if (ageInput === "21-29" && (p.yas < 21 || p.yas > 29)) show = false; if (ageInput === "30+" && p.yas < 30) show = false; }
                cards[i].style.display = show ? "flex" : "none";
            }
        }

        window.onload = parseData;
    </script>
</body>
</html>
