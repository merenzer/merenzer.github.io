<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anadolu Sigorta | Pro Broadcast Kupa Sistemi</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg-base: #f5f7fa; --bg-detail: #c3cfe2; --accent: #003366;
            --text-color: #2c3e50; --card-bg: rgba(255, 255, 255, 0.9); --sidebar-bg: #ffffff;
            --transition-speed: 0.6s;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); filter: blur(10px); }
            to { opacity: 1; transform: translateY(0); filter: blur(0); }
        }

        body {
            margin: 0; display: flex; font-family: 'Inter', 'Segoe UI', sans-serif;
            background-color: var(--bg-base);
            background-image: radial-gradient(circle at 15% 25%, var(--bg-detail) 0%, transparent 45%),
                              radial-gradient(circle at 85% 75%, var(--bg-detail) 0%, transparent 45%);
            background-attachment: fixed; min-height: 100vh; color: var(--text-color);
            transition: background-color var(--transition-speed), color 0.3s; overflow-x: auto;
        }

        /* SIDEBAR PRO */
        .sidebar {
            width: 280px; background: var(--sidebar-bg); backdrop-filter: blur(30px);
            border-right: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column;
            padding: 40px 20px; height: 100vh; position: sticky; left: 0; z-index: 1000;
            box-shadow: 10px 0 30px rgba(0,0,0,0.05);
        }

        .logo-box { margin-bottom: 50px; text-align: center; transition: transform 0.3s; }
        .logo-box:hover { transform: scale(1.05); }
        .logo-box img { max-width: 180px; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1)); }

        .cup-btn {
            border: 1px solid rgba(0,0,0,0.05); padding: 15px 20px; border-radius: 16px;
            cursor: pointer; font-weight: 700; background: rgba(255,255,255,0.5);
            margin-bottom: 12px; width: 100%; text-align: left; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            color: inherit; font-size: 14px; display: flex; align-items: center;
        }
        .cup-btn:hover { background: rgba(255,255,255,0.8); transform: translateX(5px); }
        .cup-btn.active { background: var(--accent); color: white; border-color: transparent; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }

        /* ANA İÇERİK */
        .main-content { padding: 50px; min-width: 1400px; flex: 1; animation: fadeInUp 0.8s ease-out; }
        
        .view-tabs { display: flex; justify-content: center; gap: 20px; margin-bottom: 40px; }
        .tab-btn {
            padding: 12px 30px; border-radius: 40px; border: 2px solid var(--accent);
            background: rgba(255,255,255,0.05); color: var(--text-color); font-weight: 800;
            cursor: pointer; transition: 0.3s; text-transform: uppercase; font-size: 12px; letter-spacing: 1px;
        }
        .tab-btn.active { background: var(--accent); color: white; box-shadow: 0 0 20px var(--accent); }

        /* BRACKET GRAFİKLERİ */
        .bracket-wrapper { display: flex; gap: 40px; justify-content: center; }
        .round { display: flex; flex-direction: column; justify-content: space-around; }
        
        .match-card {
            background: var(--card-bg); border-radius: 18px; margin: 15px 0;
            border: 1px solid rgba(255,255,255,0.1); transition: 0.4s; backdrop-filter: blur(10px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); min-width: 240px;
        }
        .match-card:hover { transform: scale(1.03); box-shadow: 0 15px 30px rgba(0,0,0,0.2); border-color: var(--accent); }
        
        .team { padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; font-size: 13px; font-weight: 800; }
        .team img { width: 24px; height: 24px; margin-right: 8px; vertical-align: middle; }
        
        /* ADMIN ARAÇLARI */
        .score-input { width: 45px; height: 30px; text-align: center; border: 2px solid var(--accent); border-radius: 8px; font-weight: 900; display: none; background: #fff; color: #000; }
        .admin-active .score-input { display: inline-block; }
        .admin-active .score-display { display: none; }
        .admin-trigger { position: fixed; bottom: 30px; right: 30px; background: #1a1a1a; color: white; padding: 15px 30px; border-radius: 50px; cursor: pointer; z-index: 2000; font-weight: 800; box-shadow: 0 10px 30px rgba(0,0,0,0.4); transition: 0.3s; }
        .admin-trigger:hover { transform: translateY(-5px); background: #333; }
        .save-btn { display: none; position: fixed; bottom: 30px; right: 220px; background: #00c853; color: white; padding: 15px 40px; border-radius: 50px; cursor: pointer; border: none; font-weight: 900; box-shadow: 0 10px 30px rgba(0,200,83,0.4); z-index: 2000; }
        
        /* SIFIRLAMA BUTONU */
        .reset-btn { display: none; position: fixed; top: 20px; right: 20px; background: #d32f2f; color: white; padding: 10px 20px; border-radius: 12px; cursor: pointer; border: none; font-weight: 800; box-shadow: 0 5px 15px rgba(211, 47, 47, 0.4); z-index: 2000; }

        #login-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 3000; backdrop-filter: blur(10px); }
    </style>
</head>
<body id="body-tag">

    <aside class="sidebar">
        <div class="logo-box">
            <img id="cup-logo" src="../logolar/federasyon.png" alt="Logo" onerror="this.src='../logolar/uefa.png'">
        </div>
        <nav class="nav-menu">
            <button class="cup-btn active" id="btn-fed" onclick="changeCup('federasyon', this)">FEDERASYON KUPASI</button>
            <button class="cup-btn" onclick="changeCup('sampiyonlar', this)">CHAMPIONS LEAGUE</button>
            <button class="cup-btn" onclick="changeCup('uefa', this)">EUROPA LEAGUE</button>
            <button class="cup-btn" onclick="changeCup('konferans', this)">CONFERENCE LEAGUE</button>
        </nav>
    </aside>

    <main class="main-content" id="main-content">
        <h1 id="main-title" style="text-align:center; margin-bottom: 50px; font-size: 42px; font-weight: 900; letter-spacing: -1px; text-shadow: 0 10px 20px rgba(0,0,0,0.2);">Federasyon Kupası</h1>
        <div id="tab-area" class="view-tabs" style="display:none;">
            <button class="tab-btn active" onclick="switchView('giyotin', this)">GİYOTİN (PLAY-IN)</button>
            <button class="tab-btn" onclick="switchView('protokol', this)">PROTOKOL 32 (ELEME)</button>
        </div>
        <div id="display-area"></div>
    </main>

    <div class="admin-trigger" id="login-btn" onclick="showLogin()">YÖNETİCİ PANELİ</div>
    <button class="save-btn" id="save-btn" onclick="saveData()">DEĞİŞİKLİKLERİ YAYINLA</button>
    <button class="reset-btn" id="reset-btn" onclick="resetDatabase()">⚠️ FİKSTÜRÜ SIFIRLA VE DÜZELT</button>

    <div id="login-modal">
        <div style="background: white; padding: 50px; border-radius: 30px; text-align: center; color: #333; max-width: 400px; width: 90%;">
            <h2 style="margin-top:0; font-size: 28px;">Admin Girişi</h2>
            <p style="opacity: 0.7; margin-bottom: 30px;">Turnuva skorlarını yönetmek için şifre girin.</p>
            <input type="password" id="admin-pass" style="padding:15px; border-radius:12px; border:2px solid #eee; width:100%; margin-bottom:20px; font-size:20px; text-align:center; box-sizing: border-box;">
            <button onclick="login()" style="background:#003366; color:white; padding:15px 40px; border-radius:15px; cursor:pointer; border:none; font-weight:bold; width: 100%; font-size: 16px;">SİSTEMİ AÇ</button>
            <p onclick="closeLogin()" style="margin-top:20px; cursor:pointer; font-weight:bold; color: #999;">Geri Dön</p>
        </div>
    </div>

    <script>
        // FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDj5s9VIvEWQmdEjCPHti7_ujdrg_1C_LA",
            authDomain: "kupalar-96dab.firebaseapp.com",
            projectId: "kupalar-96dab",
            databaseURL: "https://kupalar-96dab-default-rtdb.europe-west1.firebasedatabase.app/",
            storageBucket: "kupalar-96dab.firebasestorage.app",
            messagingSenderId: "929983415930",
            appId: "1:929983415930:web:b5f0b066b79422e1e5ddc3"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let isAdmin = false;
        let activeCup = 'federasyon';
        let currentView = 'giyotin';
        let localData = {};

        function getLogo(team) {
            if(!team || team === 'Bekleniyor' || team.includes('Kazanan') || team.includes('Winner')) return '';
            let clean = team.replace('*', '').trim();
            // Logo hata verirse logolar2 klasörüne bak, o da yoksa boş dön
            return `<img src="../logolar/${clean}.png" class="team-logo" onerror="this.onerror=null; this.src='../logolar2/${clean}.png';">`;
        }

        function loadData() {
            db.ref('tournamentDataV2').on('value', (snapshot) => {
                const val = snapshot.val();
                if (val) { localData = val; } 
                else { localData = initData(); db.ref('tournamentDataV2').set(localData); }
                renderContent();
            });
        }

        function initData() {
            // BAŞLANGIÇ VERİLERİ - GİYOTİN VE PROTOKOL 32 SİSTEMİ
            const blankMatch = {t1:'Bekleniyor', t2:'Bekleniyor', s1:0, s2:0};
            return {
                federasyon: {
                    // Mevcut sistem (Son 32'den başlar)
                    0: [["Galatasaray", "Kilis 1984 A.Ş."], ["Fenerbahçe", "Karaman FK"], ["Beşiktaş", "Malatya Yeşilyurt"], ["Trabzonspor", "Ağrı 1970 Spor"], ["Başakşehir FK", "Diyarbakır FK"], ["Eyüpspor", "Bursaspor"], ["Samsunspor", "Çorum FK"], ["Göztepe", "Sakaryaspor"], ["Konyaspor", "Erzurumspor"], ["Sivasspor", "Keçiörengücü"], ["Antalyaspor", "Kocaelispor"], ["Kasımpaşa", "Ümraniyespor"], ["Gaziantep FK", "Ankaragücü"], ["Rizespor", "Hatayspor"], ["Alanyaspor", "Kayserispor"], ["Adana Demirspor", "Bodrum FK"]].map(p => ({t1:p[0], t2:p[1], s1:0, s2:0})),
                    1: Array(8).fill(blankMatch), 2: Array(4).fill(blankMatch), 3: Array(2).fill(blankMatch), 4: Array(1).fill(blankMatch)
                },
                sampiyonlar: {
                    giyotin: [ // 4 Eşleşme (8 Takım)
                        {t1:"Fenerbahçe", t2:"Feyenoord", s1:0, s2:0}, 
                        {t1:"Qarabağ", t2:"Ferençvaroş", s1:0, s2:0}, 
                        {t1:"Copenhagen", t2:"Basel", s1:0, s2:0}, 
                        {t1:"Club Brugge", t2:"Rangers", s1:0, s2:0}
                    ], 
                    protokol: { // Son 32 (16 Eşleşme)
                        0: Array(16).fill(blankMatch), // Buraya 28 direkt takım + 4 Giyotin kazananı gelecek (Manuel veya Otomatik)
                        1: Array(8).fill(blankMatch), 2: Array(4).fill(blankMatch), 3: Array(2).fill(blankMatch), 4: Array(1).fill(blankMatch)
                    }
                },
                uefa: {
                    giyotin: [
                        {t1:"Beşiktaş", t2:"Kups Kuopio", s1:0, s2:0}, 
                        {t1:"Trabzonspor", t2:"AEK Larnaca", s1:0, s2:0}, 
                        {t1:"Dinamo Kyiv", t2:"Tel Aviv", s1:0, s2:0}, 
                        {t1:"Young Boys", t2:"Slovan Bratislava", s1:0, s2:0}
                    ],
                    protokol: { 0: Array(16).fill(blankMatch), 1: Array(8).fill(blankMatch), 2: Array(4).fill(blankMatch), 3: Array(2).fill(blankMatch), 4: Array(1).fill(blankMatch) }
                },
                konferans: {
                    giyotin: [
                        {t1:"Samsunspor", t2:"Paksi", s1:0, s2:0}, 
                        {t1:"Göztepe", t2:"Vikingur", s1:0, s2:0}, 
                        {t1:"Mainz", t2:"Rosenborg", s1:0, s2:0}, 
                        {t1:"Servette", t2:"Shakhtar", s1:0, s2:0}
                    ],
                    protokol: { 0: Array(16).fill(blankMatch), 1: Array(8).fill(blankMatch), 2: Array(4).fill(blankMatch), 3: Array(2).fill(blankMatch), 4: Array(1).fill(blankMatch) }
                }
            };
        }

        function renderContent() {
            const area = document.getElementById('display-area');
            area.style.animation = 'none'; area.offsetHeight; area.style.animation = 'fadeInUp 0.6s ease-out';
            
            if(activeCup === 'federasyon') { 
                area.innerHTML = renderBracket(localData.federasyon, 'fed'); 
            } else { 
                if(currentView === 'giyotin') { area.innerHTML = renderGiyotin(); }
                else { area.innerHTML = renderBracket(localData[activeCup].protokol, 'protokol'); }
            }
        }

        // Federasyon ve Protokol 32 için ortak Ağaç Yapısı
        function renderBracket(data, type) {
            const rounds = [{id: 'Son 32', c: 16}, {id: 'Son 16', c: 8}, {id: 'Çeyrek Final', c: 4}, {id: 'Yarı Final', c: 2}, {id: 'Büyük Final', c: 1}];
            let html = `<div class="bracket-wrapper">`;
            
            // Eğer veri eksikse (örn: yeni eklenen protokol yapısı)
            if(!data) return "<h3 style='text-align:center'>Turnuva verisi yükleniyor...</h3>";

            rounds.forEach((r, rIdx) => {
                // Eğer tur verisi yoksa atla
                if(!data[rIdx]) return;

                html += `<div class="round"><h4 style="text-align:center; color: var(--accent); font-size: 14px; text-transform: uppercase; margin-bottom:15px; font-weight:900; letter-spacing:1px;">${r.id}</h4>`;
                
                data[rIdx].forEach((match, mIdx) => {
                    html += `<div class="match-card">
                        <div class="team">
                            <span>${getLogo(match.t1)} ${match.t1}</span> 
                            <span class="score-display">${match.s1}</span>
                            <input type="number" class="score-input" value="${match.s1}" onchange="updateScore('${type}', ${rIdx}, ${mIdx}, 's1', this.value)">
                        </div>
                        <div class="team">
                            <span>${getLogo(match.t2)} ${match.t2}</span> 
                            <span class="score-display">${match.s2}</span>
                            <input type="number" class="score-input" value="${match.s2}" onchange="updateScore('${type}', ${rIdx}, ${mIdx}, 's2', this.value)">
                        </div>
                    </div>`;
                });
                html += `</div>`;
            });
            return html + `</div>`;
        }

        function renderGiyotin() {
            let html = `<div class="bracket-wrapper"><div class="round"><h4 style="text-align:center; color: var(--accent);">GİYOTİN (PLAY-IN)</h4>`;
            localData[activeCup].giyotin.forEach((m, i) => {
                html += `<div class="match-card">
                    <div class="team"><span>${getLogo(m.t1)} ${m.t1}</span> <input type="number" class="score-input" value="${m.s1}" onchange="updateScore('giyotin', 0, ${i}, 's1', this.value)"><span class="score-display">${m.s1}</span></div>
                    <div class="team"><span>${getLogo(m.t2)} ${m.t2}</span> <input type="number" class="score-input" value="${m.s2}" onchange="updateScore('giyotin', 0, ${i}, 's2', this.value)"><span class="score-display">${m.s2}</span></div>
                </div>`;
            });
            return html + `</div><div class="round" style="justify-content:center; padding:20px; text-align:center; color:#fff; opacity:0.7;">Kazananlar<br>Protokol 32<br>Son 4 Maç (Deplasman)</div></div>`;
        }

        // AKILLI GÜNCELLEME VE İLERLETME MANTIĞI
        function updateScore(type, r, mIdx, team, val) {
            let valNum = parseInt(val);
            if(isNaN(valNum)) valNum = 0;

            if(type === 'fed') {
                localData.federasyon[r][mIdx][team] = valNum;
                autoAdvance(localData.federasyon, r, mIdx);
            } 
            else if(type === 'protokol') {
                localData[activeCup].protokol[r][mIdx][team] = valNum;
                autoAdvance(localData[activeCup].protokol, r, mIdx);
            } 
            else if(type === 'giyotin') { 
                localData[activeCup].giyotin[mIdx][team] = valNum;
                // GIYOTIN KAZANANINI PROTOKOL 32'YE TAŞI (Son 4 maça: 12, 13, 14, 15)
                let match = localData[activeCup].giyotin[mIdx];
                if(match.s1 !== match.s2) {
                    let winner = match.s1 > match.s2 ? match.t1 : match.t2;
                    let targetMatchIndex = 12 + mIdx; // 0. maç kazananı -> 12. maçın deplasmanı
                    if(localData[activeCup].protokol[0][targetMatchIndex]) {
                        localData[activeCup].protokol[0][targetMatchIndex].t2 = winner;
                    }
                }
            }
        }

        // Kazananı otomatik bir sonraki tura taşıma
        function autoAdvance(bracketData, r, mIdx) {
            let match = bracketData[r][mIdx];
            // Eğer maç berabere değilse ve final değilse
            if(match.s1 !== match.s2 && bracketData[r+1]) {
                let winner = match.s1 > match.s2 ? match.t1 : match.t2;
                let nextMatchIdx = Math.floor(mIdx / 2);
                let nextTeamPos = mIdx % 2 === 0 ? 't1' : 't2';
                
                // Bir sonraki tura yaz
                if(bracketData[r+1][nextMatchIdx]) {
                    bracketData[r+1][nextMatchIdx][nextTeamPos] = winner;
                }
            }
        }

        function showLogin() { document.getElementById('login-modal').style.display = 'flex'; }
        function closeLogin() { document.getElementById('login-modal').style.display = 'none'; }
        function login() {
            if(document.getElementById('admin-pass').value === "5261") {
                isAdmin = true; document.getElementById('body-tag').classList.add('admin-active');
                document.getElementById('save-btn').style.display = 'block'; 
                document.getElementById('reset-btn').style.display = 'block';
                closeLogin();
            } else { alert("Hatalı Şifre!"); }
        }

        function saveData() {
            db.ref('tournamentDataV2').set(localData).then(() => { alert("Yayın güncellendi!"); });
        }

        function resetDatabase() {
            if(!isAdmin) return;
            if(confirm("Tüm verileri silip varsayılan temiz listeyi yüklemek üzeresiniz. Emin misiniz?")) {
                let cleanData = initData();
                db.ref('tournamentDataV2').set(cleanData).then(() => { 
                    alert("Veritabanı sıfırlandı!"); 
                    location.reload(); 
                });
            }
        }

        function changeCup(cup, btn) {
            activeCup = cup;
            currentView = cup === 'federasyon' ? 'league' : 'giyotin'; // Varsayılan görünümler
            
            document.querySelectorAll('.cup-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            const themes = {
                'federasyon': { b: '#f5f7fa', d: '#c3cfe2', a: '#003366', t: 'FEDERASYON KUPASI' },
                'sampiyonlar': { b: '#091442', d: '#3562A6', a: '#3562A6', t: 'CHAMPIONS LEAGUE' },
                'uefa': { b: '#0D0D0D', d: '#F47E01', a: '#F47E01', t: 'EUROPA LEAGUE' },
                'konferans': { b: '#000000', d: '#03c221', a: '#03c221', t: 'CONFERENCE LEAGUE' }
            };
            const th = themes[cup];
            document.documentElement.style.setProperty('--bg-base', th.b);
            document.documentElement.style.setProperty('--bg-detail', th.d);
            document.documentElement.style.setProperty('--accent', th.a);
            document.documentElement.style.setProperty('--text-color', cup === 'federasyon' ? '#2c3e50' : '#ffffff');
            document.documentElement.style.setProperty('--card-bg', cup === 'federasyon' ? 'rgba(255,255,255,0.95)' : 'rgba(255,255,255,0.08)');
            document.documentElement.style.setProperty('--sidebar-bg', cup === 'federasyon' ? '#ffffff' : 'rgba(0,0,0,0.4)');
            
            document.getElementById('main-title').innerText = th.t;
            document.getElementById('cup-logo').src = `../logolar/${cup}.png`;
            
            // Tab butonlarını ayarla
            const tabArea = document.getElementById('tab-area');
            if(cup === 'federasyon') { tabArea.style.display = 'none'; } 
            else { 
                tabArea.style.display = 'flex'; 
                // Tab butonlarını resetle
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelector('.tab-btn:first-child').classList.add('active');
            }
            renderContent();
        }

        function switchView(view, btn) {
            currentView = view;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderContent();
        }

        window.onload = loadData;
    </script>
</body>
</html>
